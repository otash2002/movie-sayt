generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// --- Enumlar ---
enum Role {
  USER
  ADMIN
  SUPERADMIN
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELED
  PENDING_PAYMENT
}

enum Quality {
  P240
  P360
  P480
  P720
  P1080
  P4K
}

// --- Jadvallar ---

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  email        String   @unique
  passwordHash String
  role         Role     @default(USER)
  avatarUrl    String?
  createdAt    DateTime @default(now())

  profile       Profile?
  moviesCreated Movie[]
  favorites     Favorite[]
  reviews       Review[]
  watchHistory  WatchHistory[]
  subscriptions UserSubscription[]
}

model Review {
  id        String   @id @default(uuid())
  userId    String
  movieId   String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  movie     Movie    @relation(fields: [movieId], references: [id])

  @@unique([userId, movieId])
}

model WatchHistory {
  id        String   @id @default(uuid())
  userId    String
  movieId   String
  watchedAt DateTime @default(now())
  progress  Int      @default(0)

  user      User     @relation(fields: [userId], references: [id])
  movie     Movie    @relation(fields: [movieId], references: [id])

  @@unique([userId, movieId])
}

model Profile {
  id        String   @id @default(uuid())
  fullName  String
  phone     String?
  country   String?
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Movie {
  id               String   @id @default(uuid())
  title            String
  slug             String   @unique
  description      String?
  releaseYear      Int
  durationMinutes  Int
  posterUrl        String?
  rating           Decimal  @default(0.0)
  subscriptionType String   @default("free") // free, premium
  viewCount        Int      @default(0)
  createdAt        DateTime @default(now())

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  categories   MovieCategory[]
  files        MovieFile[]
  favorites    Favorite[]
  reviews      Review[]
  watchHistory WatchHistory[]
}

model Category {
  id          String          @id @default(uuid())
  name        String          @unique
  slug        String          @unique
  description String?
  movies      MovieCategory[]
}

model MovieCategory {
  movieId    String
  categoryId String
  movie      Movie    @relation(fields: [movieId], references: [id])
  category   Category @relation(fields: [categoryId], references: [id])

  @@id([movieId, categoryId])
}

model MovieFile {
  id       String  @id @default(uuid())
  fileUrl  String
  quality  Quality
  language String  @default("uz")
  movieId  String
  movie    Movie   @relation(fields: [movieId], references: [id])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  movieId   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  movie     Movie    @relation(fields: [movieId], references: [id])

  @@unique([userId, movieId])
}

model UserSubscription {
  id        String             @id @default(uuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id])
  startDate DateTime           @default(now())
  endDate   DateTime?
  status    SubscriptionStatus @default(PENDING_PAYMENT)
}
